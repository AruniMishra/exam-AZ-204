
# Azure

- [Azure](#azure)
  - [App Service Environment](#app-service-environment)
  - [Vnet](#vnet)
  - [Azure Function](#azure-function)
    - [Durable function](#durable-function)
  - [Storage account](#storage-account)
  - [PowerShell](#powershell)
  - [Azure Cosmos DB](#azure-cosmos-db)
  - [Virtual Machine](#virtual-machine)
  - [Misc](#misc)

## App Service Environment

- In the Isolated tier, the App Service Environment defines the number of isolated workers that run your apps, and each worker is charged. In addition, there's a flat Stamp Fee for the running the App Service Environment itself. Isolated: This tier runs dedicated Azure VMs on dedicated Azure Virtual Networks. It provides network isolation on top of compute isolation to your apps. It provides the maximum scale-out capabilities.

- Specify custom warm-up
  - Some apps might require custom warm-up actions before the swap. The **applicationInitialization** configuration element in web.config lets you specify custom initialization actions. The swap operation waits for this custom warm-up to finish before swapping with the target slot. Here's a sample web.config fragment.
  
    ```xml
    <system.webServer>
        <applicationInitialization>
            <add initializationPage="/" hostName="[app hostname]" />
            <add initializationPage="/Home/About" hostName="[app hostname]" />
        </applicationInitialization>
    </system.webServer>
    ```

  - Auto-Swap is only available on Windows-based App Services
  - Requires at least a standard plan

- Within the same resource group, you can't mix Windows and Linux apps in the same region. However, all resource groups created on or after January 21, 2021 do support this scenario. For resource groups created before January 21, 2021, the ability to add mixed platform deployments will be rolled out across Azure regions (including National cloud regions) soon.

- Always On enables waking up on HTTPTrigger, but does not prevent the exceeding the max time out time of 230 seconds.

## Vnet

- Key Vault references currently only support system-assigned managed identities. User-assigned

## Azure Function

- Triggers and bindings
  
  - Use an App Service plan. Configure the Function App to use an Azure Blob Storage trigger.
  Consumption plan can cause a 10-min delay in processing new blobs if a function app has gone idle. To avoid this latency, you can switch to an App Service plan with Always On enabled. [Azure Blob storage trigger for Azure Functions](https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-storage-blob-trigger?tabs=csharp)

  - If you require faster or more reliable blob processing, consider creating a queue message when you create the blob. Then use a **queue trigger** instead of a blob trigger to process the blob. Another option is to use **Event Grid**;

### Durable function

- Durable Functions is an extension of Azure Functions that lets you write stateful functions in a serverless compute environment. The extension lets you define stateful workflows by writing orchestrator functions and stateful entities by writing entity functions using the Azure Functions programming model. Behind the scenes, the extension manages state, checkpoints, and restarts for you, allowing you to focus on your business logic.

## Storage account

- the change feed provides transaction logs of all the changes that occur to the blobs and the blob metadata in your storage account. The change feed provides ordered, guaranteed, a durable, immutable, read-only log of these changes. You can process these logs asynchronously, incrementally or in-full.

## PowerShell

- Dockerfile sequence:
  
      FROM node:latest
      WORKDIR /usr/src/app
      COPY package.json .
      RUN npm install
      COPY . ./
      EXPOSE 3000
      CMD [ “npm”, “start” ]

## Azure Cosmos DB

- Azure Cosmos DB offers five well-defined levels. From strongest to weakest, [the levels are](https://docs.microsoft.com/en-us/azure/cosmos-db/consistency-levels):
  - Strong
  - Bounded staleness
  - Session
  - Consistent prefix
  - Eventual

## Virtual Machine

- Run scripts in your Windows
  
  - Custom Script Extension
    - The Custom Script Extension is primarily used for post deployment configuration and software installation.

  - Run command
    - The Run Command feature enables virtual machine and application management and troubleshooting using scripts, and is available even when the machine is not reachable, for example if the guest firewall doesn't have the RDP or SSH port open.

- You can store images in Azure Blob Storage.

## Misc

Step 1: Create the Azure Functions app with a Premium plan type
Premium plan automatically scales based on demand using pre-warmed workers which run applications with no delay after being idle, runs on more powerful instances, and connects to virtual networks.

Step 2: Create a system-assigned managed identity for the application
When you enable a system-assigned managed identity an identity is created in Azure AD that is tied to the lifecycle of that service instance. So when the resource is deleted, Azure automatically deletes the identity for you. Key Vault references currently only support system-assigned managed identities. User-assigned identities cannot be used.

Step 3: Create an access policy in Key Vault for the application identity
Create an Access Policy in Key Vault for the application identity you created earlier. Enable the "Get" secret permission on this policy.
